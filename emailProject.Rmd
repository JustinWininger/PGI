---
title: "Email Report"
author: "Justin Wininger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 300)
remove(list = ls())
library(readxl)
library(tidyverse)
library(lubridate)
library(hrbrthemes)
library(viridis)
library(mosaic)
emails <- read_excel("PGI master.xlsx")

```

```{r, data}
emails$Day <- as.Date(emails$`Sent Date`)
emails$Day <- weekdays(emails$Day)
day_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
emails$Day <- factor(emails$Day, levels = day_order, ordered = TRUE)


emails <- emails %>% filter(`Total Recipients` > 20 & Opens > 10)

emails$Covid <- ifelse(emails$`Sent Date` < as.Date("2020-03-01"), "Pre-Covid", "Post-Covid")

covid_order <- c("Pre-Covid", "Post-Covid")
emails$Covid <- factor(emails$Covid, levels = covid_order, ordered = TRUE)

emailsMF <- emails %>% filter(Day != 'Sunday')
emailsS <- emails %>% filter(Day == 'Sunday')
emailsW <- emails %>% filter(Day == 'Wednesday')

countsMF <- emailsMF %>% 
  group_by(Day) %>%
  tally()

counts <- emails %>% 
  group_by(Day) %>%
  tally()

emails$Size <- ifelse(emails$`Total Recipients` >= 2500, "Large", "Small")
```

# Introduction

This project analyzes several statistics of 640 email campaigns sent out by clients of Endowment Development Services since 2010. 

```{r, warning = FALSE, message = FALSE}

ggplot(data=emailsMF, mapping=aes(x=Day, y=`Open Rate`, fill = Day))+
  geom_boxplot(color = '#9EA032', fill = c('#173C58', '#4091B0', '#173C58', '#4091B0', '#173C58'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = countsMF,
            aes(Day, Inf, label = n), vjust = 1)

# Plot
emailsMF %>%
  ggplot( aes(x=Day, y=`Open Rate`, fill=Day)) +
    geom_violin(width=1.0) +
    geom_boxplot(width=0.1, color="grey", alpha=0.2) +
    scale_fill_viridis(discrete = TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = countsMF,
            aes(Day, Inf, label = n), vjust = 1)

emailsBC <- subset(emailsMF, Covid == "Pre-covid")
emailsAC <- subset(emailsMF, Covid == "Post-covid")

countsMF2 <- emailsMF %>% 
  group_by(Day, Covid) %>%
  tally()

emailsMF %>%
  ggplot(aes(Day, `Open Rate`, fill = Day,))+
  geom_boxplot()+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11),
      axis.text.x = element_text(angle = 45)
    )+
  facet_wrap( ~ Covid)+
  geom_text(data = countsMF2,
            aes(Day, Inf, label = n), vjust = 1)
```

```{r message = FALSE, warning = FALSE}
emails <- emails %>% mutate(`Subject Length` = nchar(Subject))

ggplot(data=emails, mapping=aes(x=`Subject Length`, y=`Open Rate`))+
  geom_point(color = c('#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_smooth(method=lm,se=FALSE, color = '#173C58')+
  labs(Title = 'Open Rate by Subject Length',
       x = 'Subject Length (characters)')

SL <- lm(`Open Rate` ~ `Subject Length`, data = emails)

sSL <- summary(SL)

sSLo <- sSL[["coefficients"]]
```

```{r}
has_punctuation <- function(text) {
  grepl("[[:punct:]]", text)
}

# Add a new column 'contains_punctuation' based on the presence of punctuation
emails <- emails %>%
  mutate(Punctuation = ifelse(has_punctuation(Subject), "Yes", "No"))

counts2 <- emails %>% 
  group_by(Punctuation) %>%
  tally()

emails %>%
  ggplot(aes(Punctuation, `Open Rate`, fill = Punctuation))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = counts2,
            aes(Punctuation, Inf, label = n), vjust = 1)

puncM <- lm(`Open Rate` ~ Punctuation, data=emails)
apuncM <- anova(puncM)
```

```{r}
# Function to check for specific punctuation marks
has_period <- function(text) {
  grepl("\\.", text)
}

has_colon <- function(text) {
  grepl(":", text)
}

has_exclamation <- function(text) {
  grepl("!", text)
}

has_question <- function(text) {
  grepl("\\?", text)
}

# Add new columns for specific punctuation marks
emails <- emails %>%
  mutate(
    Period = ifelse(has_period(Subject), "Yes", "No"),
    Colon = ifelse(has_colon(Subject), "Yes", "No"),
    ExclamationPoint = ifelse(has_exclamation(Subject), "Yes", "No"),
    QuestionMark = ifelse(has_question(Subject), "Yes", "No")
  )
```

```{r}
haveP <- emails %>% 
  filter(Period == "Yes") %>%
  mutate(Punc = "Period")
haveC <- emails %>% 
  filter(Colon == "Yes") %>%
  mutate(Punc = "Colon")
haveE <- emails %>% 
  filter(ExclamationPoint == "Yes")%>%
  mutate(Punc = "Exclamation Point")
haveQ <- emails %>% 
  filter(QuestionMark == "Yes")%>%
  mutate(Punc = "Question Mark")

havePC <- rbind(haveP, haveC)
haveEQ <- rbind(haveE, haveQ)

havePCEQ <- rbind(havePC, haveEQ)

counts7 <- havePCEQ %>% 
  group_by(Punc) %>%
  tally()

havePCEQ %>%
  ggplot(aes(Punc, `Open Rate`, fill = Punc))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0', '#173C58', '#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = counts7,
            aes(Punc, Inf, label = n), vjust = 1)
```

```{r, warning = FALSE, message = FALSE}
analyze_last_char <- function(text) {
  last_char <- substr(text, nchar(text), nchar(text))
  if (last_char == ".") {
    return("Period")
  } else if (last_char == "!") {
    return("Exclamation")
  } else if (last_char == "?") {
    return("Question")
  } else if (last_char == ":") {
    return("Colon")
  } else {
    return("No Punctuation")
  }
}

# Create new column with analysis of last character
emails$lastChar <- sapply(emails$Subject, analyze_last_char)

emailsLC <- emails %>% 
  filter(lastChar == 'Period' | lastChar == 'No Punctuation') 

counts6 <- emailsLC %>% 
  group_by(lastChar) %>%
  tally()

emailsLC %>%
  ggplot(aes(lastChar, `Open Rate`, fill = lastChar))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = counts6,
            aes(lastChar, Inf, label = n), vjust = 1)+
  labs(x= 'Last Character',
       y= 'Open Rate',
       title = ' Open Rate by Last Character')

emailsLC %>%
  ggplot( aes(x=lastChar, y=`Open Rate`, fill=lastChar)) +
    geom_violin(width=1.0) +
    geom_boxplot(width=0.1, color="#9EA032", alpha=0.2) +
    scale_fill_viridis(discrete = TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = counts6,
            aes(lastChar, Inf, label = n), vjust = 1) +
  labs(x= 'Last Character',
       y= 'Open Rate',
       title = ' Open Rate by Last Character')+
  scale_fill_manual(values=c('#173C58', '#4091B0'))



modelLC <- lm(`Open Rate` ~ lastChar, emailsLC)
amodelLC <- anova(modelLC)
```

```{r}
noPunc <- emails %>% filter(Punctuation == "No")
noPunc <- noPunc %>%
  mutate (Source = "No Punctuation")
emailsNP <- emailsLC %>% 
  filter(lastChar == 'No Punctuation') %>%
  mutate (Source = "No Ending Punctuation")
emailsP <- emailsLC %>% 
  filter(lastChar == 'Period')%>%
  mutate (Source = "Ending Period") 
tmp <- rbind(emailsNP, emailsP)
both <- rbind(tmp, noPunc)

countsBoth <- both %>% 
  group_by(Source) %>%
  tally()

both2 <- rbind(emailsP, noPunc)

countsBoth2 <- both2 %>% 
  group_by(Source) %>%
  tally()

both %>%
  ggplot(aes(Source, `Open Rate`, fill = Source))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0', '#173C58'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = countsBoth,
            aes(Source, Inf, label = n), vjust = 1)

modelBoth <- lm(`Open Rate` ~ Source, both)
amB <- anova(modelBoth)

both2 %>%
  ggplot(aes(Source, `Open Rate`, fill = Source))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = countsBoth2,
            aes(Source, Inf, label = n), vjust = 1)

modelBoth2 <- lm(`Open Rate` ~ Source, both2)
amB2 <- anova(modelBoth2)
```

```{r}
countsSize <- emails %>% 
  group_by(Size) %>%
  tally()

emails %>% 
  ggplot(aes(Size, `Open Rate`, fill = Size))+
  geom_boxplot(color= '#9EA032', fill = c('#173C58', '#4091B0'))+
  theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    )+
  geom_text(data = countsSize,
            aes(Size, Inf, label = n), vjust = 1)


# scale_fill_manual(values=c('orange', 'green', 'navy'))
# for boxplots etc

sizeM <- lm(`Open Rate` ~ Size, emails)
asizeM <- anova(sizeM)
```